<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¬í”Œ íˆ¬ë‘ì•±</title>

    <!-- Reactì™€ Babelì„ CDNìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê¸° -->
    <!-- React: í™”ë©´ì„ ë§Œë“¤ê³  ê´€ë¦¬í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <!-- ReactDOM: Reactë¥¼ ì‹¤ì œ ì›¹ í˜ì´ì§€ì— í‘œì‹œí•´ì£¼ëŠ” ë„êµ¬ -->
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel: JSX ë¬¸ë²•ì„ ë¸Œë¼ìš°ì €ê°€ ì´í•´í•  ìˆ˜ ìˆëŠ” JavaScriptë¡œ ë³€í™˜ -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS: ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ ê¸°ë°˜ CSS í”„ë ˆì„ì›Œí¬ -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen flex items-center justify-center p-5">
    <!-- React ì•±ì´ í‘œì‹œë  ìœ„ì¹˜ -->
    <div id="root"></div>

    <!-- React ì»´í¬ë„ŒíŠ¸ì™€ ë¡œì§ -->
    <script type="text/babel">
        // ========== ë°±ì—”ë“œ API ì„¤ì • ==========
        // ìƒëŒ€ê²½ë¡œë¥¼ ì‚¬ìš©í•˜ë©´ ë¡œì»¬(localhost)ì´ë“  ë°°í¬ ì„œë²„ë“ 
        // ì–´ë–¤ í™˜ê²½ì—ì„œë“  ìë™ìœ¼ë¡œ í˜„ì¬ ì„œë²„ì˜ /apië¡œ ìš”ì²­í•©ë‹ˆë‹¤
        const API_BASE_URL = '/api';

        // Reactì˜ useState, useEffect í›…ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ê°€ì ¸ì˜¤ê¸°
        const { useState, useEffect } = React;

        // ========== ì¸ì¦ í—¬í¼ í•¨ìˆ˜ ==========
        // JWT í† í°ì„ ë¸Œë¼ìš°ì €ì˜ localStorageì— ì €ì¥/ì¡°íšŒ/ì‚­ì œí•˜ëŠ” í•¨ìˆ˜ë“¤
        // localStorage: ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ë„ ë°ì´í„°ê°€ ìœ ì§€ë˜ëŠ” ì €ì¥ì†Œ
        // ë§ˆì¹˜ "ì¶œì…ì¦"ì„ ì§€ê°‘ì— ë„£ì–´ë‘ëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤

        // ì €ì¥ëœ í† í° ê°€ì ¸ì˜¤ê¸°
        const getToken = () => localStorage.getItem('auth_token');

        // í† í° ì €ì¥í•˜ê¸°
        const setToken = (token) => localStorage.setItem('auth_token', token);

        // í† í° ì‚­ì œí•˜ê¸° (ë¡œê·¸ì•„ì›ƒ ì‹œ ì‚¬ìš©)
        const removeToken = () => localStorage.removeItem('auth_token');

        // ì¸ì¦ëœ API í˜¸ì¶œì„ ìœ„í•œ í—¬í¼ í•¨ìˆ˜
        // ëª¨ë“  API ìš”ì²­ì— "ì¶œì…ì¦(í† í°)"ì„ ìë™ìœ¼ë¡œ ì²¨ë¶€í•©ë‹ˆë‹¤
        //
        // ë™ì‘ íë¦„:
        // 1. localStorageì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
        // 2. Authorization í—¤ë”ì— í† í° ì¶”ê°€
        // 3. fetch ìš”ì²­ ë³´ë‚´ê¸°
        // 4. 401 ì‘ë‹µ(ë¡œê·¸ì¸ ë§Œë£Œ) ì‹œ ìë™ ë¡œê·¸ì•„ì›ƒ
        const authFetch = async (url, options = {}) => {
            const token = getToken();
            const headers = {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {}),
                ...options.headers
            };

            const response = await fetch(url, { ...options, headers });

            // 401 ì‘ë‹µ = í† í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ
            if (response.status === 401) {
                removeToken();
                // í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
                window.location.reload();
                throw new Error('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }

            return response;
        };

        // ========== LoginForm ì»´í¬ë„ŒíŠ¸ ==========
        // ë¡œê·¸ì¸ í™”ë©´: ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì—¬ ë¡œê·¸ì¸í•©ë‹ˆë‹¤
        //
        // props:
        //   onLoginSuccess: ë¡œê·¸ì¸ ì„±ê³µ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ (ì‚¬ìš©ì ì •ë³´, í† í° ì „ë‹¬)
        //   onGoToRegister: "íšŒì›ê°€ì…" ë§í¬ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
        function LoginForm({ onLoginSuccess, onGoToRegister }) {
            // ì…ë ¥ ìƒíƒœ ê´€ë¦¬
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);

            // ë¡œê·¸ì¸ ì²˜ë¦¬ í•¨ìˆ˜
            // ë™ì‘ íë¦„: ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì „ì†¡ â†’ ì„œë²„ ê²€ì¦ â†’ í† í° ë°œê¸‰ â†’ íˆ¬ë‘ í™”ë©´ìœ¼ë¡œ
            const handleLogin = async (e) => {
                e.preventDefault(); // í¼ ê¸°ë³¸ ë™ì‘(í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨) ë°©ì§€
                setError(null);
                setLoading(true);

                try {
                    const response = await fetch(`${API_BASE_URL}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }

                    // ë¡œê·¸ì¸ ì„±ê³µ! ë¶€ëª¨ ì»´í¬ë„ŒíŠ¸(App)ì— ì•Œë¦¼
                    onLoginSuccess(result.data.user, result.data.token);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md p-10">
                    {/* ì œëª© */}
                    <h1 className="text-indigo-500 text-center mb-2 text-4xl font-bold">
                        âœ¨ ì˜¤ëŠ˜ í•  ì¼
                    </h1>
                    <p className="text-gray-400 text-center mb-8">
                        ë¡œê·¸ì¸í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”
                    </p>

                    {/* ì—ëŸ¬ ë©”ì‹œì§€ */}
                    {error && (
                        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-xl">
                            <p className="text-sm">{error}</p>
                        </div>
                    )}

                    {/* ë¡œê·¸ì¸ í¼ */}
                    <form onSubmit={handleLogin}>
                        {/* ì´ë©”ì¼ ì…ë ¥ */}
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-semibold mb-2">
                                ì´ë©”ì¼
                            </label>
                            <input
                                type="email"
                                className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-base outline-none transition-all duration-300 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100"
                                placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                autoComplete="email"
                                required
                            />
                        </div>

                        {/* ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ */}
                        <div className="mb-6">
                            <label className="block text-gray-700 text-sm font-semibold mb-2">
                                ë¹„ë°€ë²ˆí˜¸
                            </label>
                            <input
                                type="password"
                                className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-base outline-none transition-all duration-300 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100"
                                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                autoComplete="current-password"
                                required
                            />
                        </div>

                        {/* ë¡œê·¸ì¸ ë²„íŠ¼ */}
                        <button
                            type="submit"
                            disabled={loading}
                            className="w-full py-4 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-xl font-semibold cursor-pointer transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg active:translate-y-0 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {loading ? 'ë¡œê·¸ì¸ ì¤‘...' : 'ë¡œê·¸ì¸'}
                        </button>
                    </form>

                    {/* íšŒì›ê°€ì… ë§í¬ */}
                    <p className="text-center mt-6 text-gray-500">
                        ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?{' '}
                        <button
                            onClick={onGoToRegister}
                            className="text-indigo-500 font-semibold hover:underline cursor-pointer"
                        >
                            íšŒì›ê°€ì…
                        </button>
                    </p>
                </div>
            );
        }

        // ========== RegisterForm ì»´í¬ë„ŒíŠ¸ ==========
        // íšŒì›ê°€ì… í™”ë©´: ì´ë©”ì¼, ë¹„ë°€ë²ˆí˜¸, ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì„ ì…ë ¥í•˜ì—¬ ê°€ì…í•©ë‹ˆë‹¤
        //
        // props:
        //   onRegisterSuccess: íšŒì›ê°€ì… ì„±ê³µ ì‹œ í˜¸ì¶œ (ìë™ ë¡œê·¸ì¸)
        //   onGoToLogin: "ë¡œê·¸ì¸" ë§í¬ í´ë¦­ ì‹œ í˜¸ì¶œ
        function RegisterForm({ onRegisterSuccess, onGoToLogin }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);

            // íšŒì›ê°€ì… ì²˜ë¦¬ í•¨ìˆ˜
            // ë™ì‘ íë¦„: ì…ë ¥ê°’ ê²€ì¦ â†’ ì„œë²„ì— ë“±ë¡ â†’ í† í° ë°œê¸‰ â†’ ìë™ ë¡œê·¸ì¸
            const handleRegister = async (e) => {
                e.preventDefault();
                setError(null);

                // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì¼ì¹˜ ì—¬ë¶€ ê²€ì¦
                if (password !== confirmPassword) {
                    setError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }

                // ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´ ê²€ì¦
                if (password.length < 6) {
                    setError('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }

                setLoading(true);

                try {
                    const response = await fetch(`${API_BASE_URL}/auth/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.error || 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }

                    // íšŒì›ê°€ì… ì„±ê³µ â†’ ìë™ ë¡œê·¸ì¸
                    onRegisterSuccess(result.data.user, result.data.token);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md p-10">
                    {/* ì œëª© */}
                    <h1 className="text-indigo-500 text-center mb-2 text-4xl font-bold">
                        âœ¨ íšŒì›ê°€ì…
                    </h1>
                    <p className="text-gray-400 text-center mb-8">
                        ìƒˆ ê³„ì •ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”
                    </p>

                    {/* ì—ëŸ¬ ë©”ì‹œì§€ */}
                    {error && (
                        <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-xl">
                            <p className="text-sm">{error}</p>
                        </div>
                    )}

                    {/* íšŒì›ê°€ì… í¼ */}
                    <form onSubmit={handleRegister}>
                        {/* ì´ë©”ì¼ ì…ë ¥ */}
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-semibold mb-2">
                                ì´ë©”ì¼
                            </label>
                            <input
                                type="email"
                                className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-base outline-none transition-all duration-300 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100"
                                placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                autoComplete="email"
                                required
                            />
                        </div>

                        {/* ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ */}
                        <div className="mb-4">
                            <label className="block text-gray-700 text-sm font-semibold mb-2">
                                ë¹„ë°€ë²ˆí˜¸
                            </label>
                            <input
                                type="password"
                                className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-base outline-none transition-all duration-300 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100"
                                placeholder="6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                autoComplete="new-password"
                                required
                                minLength={6}
                            />
                        </div>

                        {/* ë¹„ë°€ë²ˆí˜¸ í™•ì¸ */}
                        <div className="mb-6">
                            <label className="block text-gray-700 text-sm font-semibold mb-2">
                                ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                            </label>
                            <input
                                type="password"
                                className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-base outline-none transition-all duration-300 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100"
                                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                                value={confirmPassword}
                                onChange={(e) => setConfirmPassword(e.target.value)}
                                autoComplete="new-password"
                                required
                            />
                        </div>

                        {/* íšŒì›ê°€ì… ë²„íŠ¼ */}
                        <button
                            type="submit"
                            disabled={loading}
                            className="w-full py-4 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-xl font-semibold cursor-pointer transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg active:translate-y-0 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {loading ? 'ê°€ì… ì¤‘...' : 'íšŒì›ê°€ì…'}
                        </button>
                    </form>

                    {/* ë¡œê·¸ì¸ ë§í¬ */}
                    <p className="text-center mt-6 text-gray-500">
                        ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?{' '}
                        <button
                            onClick={onGoToLogin}
                            className="text-indigo-500 font-semibold hover:underline cursor-pointer"
                        >
                            ë¡œê·¸ì¸
                        </button>
                    </p>
                </div>
            );
        }

        // ========== TodoApp ì»´í¬ë„ŒíŠ¸ ==========
        // íˆ¬ë‘ì•± ë©”ì¸ í™”ë©´: ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ í•  ì¼ ëª©ë¡ì„ ê´€ë¦¬í•©ë‹ˆë‹¤
        //
        // props:
        //   user: í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ({ id, email })
        //   onLogout: ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
        function TodoApp({ user, onLogout }) {
            // ========== ìƒíƒœ(State) ì •ì˜ ==========
            const [todos, setTodos] = useState([]);
            const [inputValue, setInputValue] = useState('');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            // ì»´í¬ë„ŒíŠ¸ê°€ ì²˜ìŒ ë‚˜íƒ€ë‚  ë•Œ ë°ì´í„° ë¡œë“œ
            useEffect(() => {
                fetchTodos();
            }, []);

            // ========== í•¨ìˆ˜ ì •ì˜ ==========

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°±ì—… (ì‚¬ìš©ìë³„ë¡œ ë¶„ë¦¬)
            const saveTodosToLocal = (todos) => {
                localStorage.setItem(`todos_backup_${user.id}`, JSON.stringify(todos));
            };

            const loadTodosFromLocal = () => {
                const backup = localStorage.getItem(`todos_backup_${user.id}`);
                return backup ? JSON.parse(backup) : [];
            };

            // í•  ì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ì¸ì¦ëœ API í˜¸ì¶œ)
            const fetchTodos = async (retries = 3) => {
                setLoading(true);
                setError(null);

                for (let i = 0; i < retries; i++) {
                    try {
                        // authFetch: í† í°ì´ ìë™ìœ¼ë¡œ ì²¨ë¶€ë©ë‹ˆë‹¤
                        const response = await authFetch(`${API_BASE_URL}/todos`);

                        if (!response.ok) {
                            throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                        }

                        const result = await response.json();
                        setTodos(result.data || []);
                        saveTodosToLocal(result.data || []);
                        setLoading(false);
                        return;
                    } catch (err) {
                        console.error(`ì‹œë„ ${i + 1}/${retries} ì‹¤íŒ¨:`, err);

                        if (i === retries - 1) {
                            const localTodos = loadTodosFromLocal();
                            if (localTodos.length > 0) {
                                setTodos(localTodos);
                                setError('ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ë¡œì»¬ ë°ì´í„°ë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.');
                            } else {
                                setError('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                            }
                            setLoading(false);
                        } else {
                            await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                        }
                    }
                }
            };

            // í•  ì¼ ì¶”ê°€ (ì¸ì¦ëœ API í˜¸ì¶œ)
            const addTodo = async () => {
                if (inputValue.trim() === '') return;

                try {
                    const response = await authFetch(`${API_BASE_URL}/todos`, {
                        method: 'POST',
                        body: JSON.stringify({ text: inputValue })
                    });

                    if (!response.ok) {
                        throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                    }

                    const result = await response.json();
                    setTodos([result.data, ...todos]);
                    setInputValue('');
                } catch (err) {
                    console.error('í•  ì¼ ì¶”ê°€ ì˜¤ë¥˜:', err);
                    setError('í•  ì¼ì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            };

            // í•  ì¼ ì‚­ì œ (ì¸ì¦ëœ API í˜¸ì¶œ)
            const deleteTodo = async (id) => {
                try {
                    const response = await authFetch(`${API_BASE_URL}/todos/${id}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                    }

                    setTodos(todos.filter(todo => todo.id !== id));
                } catch (err) {
                    console.error('ì‚­ì œ ì˜¤ë¥˜:', err);
                    setError('í•  ì¼ì„ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            };

            // ì™„ë£Œ ìƒíƒœ í† ê¸€ (ì¸ì¦ëœ API í˜¸ì¶œ)
            const toggleTodo = async (id) => {
                const todo = todos.find(t => t.id === id);

                try {
                    const response = await authFetch(`${API_BASE_URL}/todos/${id}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ completed: !todo.completed })
                    });

                    if (!response.ok) {
                        throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                    }

                    setTodos(todos.map(t =>
                        t.id === id ? { ...t, completed: !t.completed } : t
                    ));
                } catch (err) {
                    console.error('ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', err);
                    setError('í•  ì¼ì„ ì—…ë°ì´íŠ¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            };

            // Enter í‚¤ë¡œ í•  ì¼ ì¶”ê°€ (onKeyDown ì‚¬ìš© â€” onKeyPressëŠ” deprecated)
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    addTodo();
                }
            };

            // ========== í™”ë©´ ë Œë”ë§ ==========
            return (
                <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md p-10">
                    {/* í—¤ë”: ì œëª© + ì‚¬ìš©ì ì •ë³´ + ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */}
                    <div className="flex items-center justify-between mb-8">
                        <h1 className="text-indigo-500 text-3xl font-bold">
                            âœ¨ ì˜¤ëŠ˜ í•  ì¼
                        </h1>
                        <div className="flex items-center gap-3">
                            {/* í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì´ë©”ì¼ í‘œì‹œ */}
                            <span className="text-sm text-gray-400 max-w-[120px] truncate">
                                {user.email}
                            </span>
                            {/* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */}
                            <button
                                onClick={onLogout}
                                className="px-3 py-1.5 bg-gray-200 text-gray-600 rounded-lg text-sm font-semibold hover:bg-gray-300 transition-colors duration-200"
                            >
                                ë¡œê·¸ì•„ì›ƒ
                            </button>
                        </div>
                    </div>

                    {/* ì—ëŸ¬ ë©”ì‹œì§€ */}
                    {error && (
                        <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded-xl">
                            <p className="text-sm">{error}</p>
                        </div>
                    )}

                    {/* ì…ë ¥ ì˜ì—­ */}
                    <div className="flex gap-2.5 mb-6">
                        <input
                            type="text"
                            className="flex-1 px-5 py-4 border-2 border-gray-300 rounded-xl text-base outline-none transition-all duration-300 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100"
                            placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”..."
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            onKeyDown={handleKeyDown}
                            maxLength={500}
                        />
                        <button
                            className="px-8 py-4 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-xl font-semibold cursor-pointer transition-all duration-200 hover:-translate-y-0.5 hover:shadow-lg active:translate-y-0"
                            onClick={addTodo}
                        >
                            ì¶”ê°€
                        </button>
                    </div>

                    {/* í•  ì¼ ëª©ë¡ */}
                    <ul className="list-none">
                        {loading ? (
                            <div className="text-center text-gray-400 py-10 px-5 text-lg">
                                <div className="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-2"></div>
                                <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </div>
                        ) : todos.length === 0 ? (
                            <div className="text-center text-gray-400 py-10 px-5 text-lg">
                                í•  ì¼ì„ ì¶”ê°€í•´ë³´ì„¸ìš”! ğŸ¯
                            </div>
                        ) : (
                            todos.map(todo => (
                                <li
                                    key={todo.id}
                                    className={`flex items-center p-4 bg-gray-50 rounded-xl mb-2.5 transition-all duration-300 hover:bg-gray-100 hover:translate-x-1 ${todo.completed ? 'opacity-60' : ''}`}
                                >
                                    <input
                                        type="checkbox"
                                        className="w-5 h-5 mr-4 cursor-pointer accent-indigo-500"
                                        checked={todo.completed}
                                        onChange={() => toggleTodo(todo.id)}
                                    />
                                    <span className={`flex-1 text-base ${todo.completed ? 'line-through text-gray-400' : 'text-gray-800'}`}>
                                        {todo.text}
                                    </span>
                                    <button
                                        className="bg-red-500 text-white rounded-md px-4 py-2 cursor-pointer text-sm transition-colors duration-300 hover:bg-red-600"
                                        onClick={() => deleteTodo(todo.id)}
                                    >
                                        ì‚­ì œ
                                    </button>
                                </li>
                            ))
                        )}
                    </ul>
                </div>
            );
        }

        // ========== App ì»´í¬ë„ŒíŠ¸ (ìµœìƒìœ„) ==========
        // ì¸ì¦ ìƒíƒœì— ë”°ë¼ í™”ë©´ì„ ì „í™˜í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ ì—­í• 
        //
        // í™”ë©´ ì „í™˜ íë¦„:
        // 1. ì•± ì‹œì‘ â†’ ì €ì¥ëœ í† í° í™•ì¸ â†’ ìœ íš¨í•˜ë©´ íˆ¬ë‘ í™”ë©´, ì•„ë‹ˆë©´ ë¡œê·¸ì¸ í™”ë©´
        // 2. ë¡œê·¸ì¸ í™”ë©´ â†” íšŒì›ê°€ì… í™”ë©´ (ì„œë¡œ ì´ë™ ê°€ëŠ¥)
        // 3. ë¡œê·¸ì¸/íšŒì›ê°€ì… ì„±ê³µ â†’ íˆ¬ë‘ í™”ë©´
        // 4. ë¡œê·¸ì•„ì›ƒ â†’ ë¡œê·¸ì¸ í™”ë©´
        function App() {
            // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ (nullì´ë©´ ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ìƒíƒœ)
            const [user, setUser] = useState(null);

            // í˜„ì¬ ë³´ì—¬ì¤„ í™”ë©´: 'login', 'register', 'todos'
            const [currentPage, setCurrentPage] = useState('login');

            // ì•± ì´ˆê¸° ë¡œë”© ìƒíƒœ (ì €ì¥ëœ í† í° í™•ì¸ ì¤‘)
            const [appLoading, setAppLoading] = useState(true);

            // ì•± ì‹œì‘ ì‹œ ì €ì¥ëœ í† í°ìœ¼ë¡œ ìë™ ë¡œê·¸ì¸ ì‹œë„
            // ì´ì „ì— ë¡œê·¸ì¸í•œ ì ì´ ìˆìœ¼ë©´ ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤
            useEffect(() => {
                const checkAuth = async () => {
                    const token = getToken();

                    // ì €ì¥ëœ í† í°ì´ ì—†ìœ¼ë©´ â†’ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
                    if (!token) {
                        setAppLoading(false);
                        return;
                    }

                    try {
                        // ì €ì¥ëœ í† í°ì´ ìœ íš¨í•œì§€ ì„œë²„ì— í™•ì¸
                        const response = await fetch(`${API_BASE_URL}/auth/me`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            setUser(result.data.user);
                            setCurrentPage('todos');
                        } else {
                            // í† í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŒ â†’ ì‚­ì œ
                            removeToken();
                        }
                    } catch (err) {
                        console.error('ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨:', err);
                        removeToken();
                    }

                    setAppLoading(false);
                };

                checkAuth();
            }, []);

            // ë¡œê·¸ì¸ ì„±ê³µ í•¸ë“¤ëŸ¬
            // í† í°ì„ ì €ì¥í•˜ê³  íˆ¬ë‘ í™”ë©´ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤
            const handleLoginSuccess = (userData, token) => {
                setToken(token);
                setUser(userData);
                setCurrentPage('todos');
            };

            // ë¡œê·¸ì•„ì›ƒ í•¸ë“¤ëŸ¬
            // í† í°ì„ ì‚­ì œí•˜ê³  ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤
            const handleLogout = () => {
                removeToken();
                setUser(null);
                setCurrentPage('login');
            };

            // ì´ˆê¸° ë¡œë”© í™”ë©´ (í† í° í™•ì¸ ì¤‘)
            if (appLoading) {
                return (
                    <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md p-10 text-center">
                        <div className="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-4"></div>
                        <p className="text-gray-500">ë¡œë”© ì¤‘...</p>
                    </div>
                );
            }

            // í™”ë©´ ì „í™˜ ë¡œì§
            // currentPage ê°’ì— ë”°ë¼ ë‹¤ë¥¸ ì»´í¬ë„ŒíŠ¸ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤
            if (currentPage === 'register') {
                return (
                    <RegisterForm
                        onRegisterSuccess={handleLoginSuccess}
                        onGoToLogin={() => setCurrentPage('login')}
                    />
                );
            }

            if (currentPage === 'todos' && user) {
                return (
                    <TodoApp
                        user={user}
                        onLogout={handleLogout}
                    />
                );
            }

            // ê¸°ë³¸: ë¡œê·¸ì¸ í™”ë©´
            return (
                <LoginForm
                    onLoginSuccess={handleLoginSuccess}
                    onGoToRegister={() => setCurrentPage('register')}
                />
            );
        }

        // ========== React ì•±ì„ í™”ë©´ì— í‘œì‹œ ==========
        // App ì»´í¬ë„ŒíŠ¸ë¥¼ ìµœìƒìœ„ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
